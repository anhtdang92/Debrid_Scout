{% extends "base.html" %}

{% block title %}HereSphere Library{% endblock %}

{% block content %}
<h2><i class="fa-solid fa-vr-cardboard"></i> HereSphere Library</h2>

<!-- Connection Banner -->
{% if hs_url %}
<div class="hs-banner">
    <div class="hs-banner-icon">
        <i class="fa-solid fa-link"></i>
    </div>
    <div class="hs-banner-body">
        <p class="hs-banner-title">Connect from your headset</p>
        <p class="hs-banner-instruction">Enter this URL in HereSphere's built-in browser:</p>
        <div class="hs-banner-url-row">
            <code class="hs-banner-url" id="hs-url">{{ hs_url }}</code>
            <button class="button hs-copy-btn" data-action="copy-hs-url" title="Copy to clipboard">
                <i class="fa-solid fa-copy"></i> Copy
            </button>
        </div>
    </div>
</div>
{% endif %}

{% if error %}
<div class="error-message">
    <i class="fa-solid fa-exclamation-triangle"></i> {{ error }}
</div>
{% endif %}

<!-- Search / Filter / Sort -->
<div class="hs-toolbar">
    <div class="hs-search-wrap">
        <i class="fa-solid fa-magnifying-glass hs-search-icon"></i>
        <input type="text" id="hs-search" class="hs-search" placeholder="Filter library..." autocomplete="off">
    </div>
    <div class="hs-sort-wrap">
        <label for="hs-sort" class="hs-sort-label"><i class="fa-solid fa-arrow-down-wide-short"></i></label>
        <select id="hs-sort" class="hs-sort">
            <option value="date-desc">Date (Newest)</option>
            <option value="date-asc">Date (Oldest)</option>
            <option value="name-asc">Name (A-Z)</option>
            <option value="name-desc">Name (Z-A)</option>
            <option value="size-desc">Size (Largest)</option>
            <option value="size-asc">Size (Smallest)</option>
        </select>
    </div>
    <span class="hs-count" id="hs-count">{{ videos|length }} video{{ 's' if videos|length != 1 else '' }}</span>
</div>

<!-- Card Grid -->
{% if videos %}
<div class="hs-grid" id="hs-grid">
    {% for v in videos %}
    <div class="hs-card" data-id="{{ v.id }}" data-name="{{ v.name|lower }}" data-date="{{ v.added }}" data-size="{{ v.byte_size }}">
        <div class="hs-thumb-wrap">
            <img class="hs-thumb"
                 src="{{ v.thumb_url }}"
                 alt="{{ v.name }}"
                 loading="lazy"
                 onerror="this.parentElement.classList.add('hs-thumb-error')">
            <div class="hs-thumb-placeholder">
                <i class="fa-solid fa-film"></i>
            </div>
            <span class="hs-badge hs-badge-overlay">{{ v.projection_label }}</span>
            {% if v.is_favorite %}
            <span class="hs-favorite-badge" title="Favorite"><i class="fa-solid fa-heart"></i></span>
            {% endif %}
            {% if v.is_watched %}
            <span class="hs-watched-badge" title="Watched"><i class="fa-solid fa-eye"></i></span>
            {% endif %}
        </div>
        <div class="hs-card-body">
            <div class="hs-card-title-row">
                <h4 class="hs-card-title" title="{{ v.raw_name }}">{{ v.name }}</h4>
                {% if v.added %}
                <span class="hs-date">{{ v.added }}</span>
                {% endif %}
            </div>
            {% if v.rating %}
            <div class="hs-card-rating" title="{{ v.rating }} / 5">
                {% for i in range(1, 6) %}
                    {% if v.rating >= i %}
                    <i class="fa-solid fa-star"></i>
                    {% elif v.rating >= i - 0.5 %}
                    <i class="fa-solid fa-star-half-stroke"></i>
                    {% else %}
                    <i class="fa-regular fa-star"></i>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <div class="hs-card-meta">
                <span><i class="fa-solid fa-hard-drive"></i> {{ v.size }}</span>
                {% if v.links_count %}
                <span><i class="fa-solid fa-file-video"></i> {{ v.links_count }} file{{ 's' if v.links_count != 1 else '' }}</span>
                {% endif %}
            </div>
        </div>
        <div class="hs-card-actions">
            <button class="button hs-action-btn" data-action="hs-launch" data-id="{{ v.id }}" title="Launch in HereSphere">
                <i class="fa-solid fa-vr-cardboard"></i> HereSphere
            </button>
            <button class="button hs-action-btn" data-action="hs-vlc" data-id="{{ v.id }}" title="Launch in VLC">
                <i class="fa-solid fa-play"></i> VLC
            </button>
            <button class="button hs-action-btn hs-files-btn" data-action="show-files" data-id="{{ v.id }}" title="Browse files">
                <i class="fa-solid fa-folder-open"></i> Files
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<p class="hs-no-match" id="hs-no-match" style="display:none;">No videos match your filter.</p>
{% else %}
<div class="hs-empty">
    <i class="fa-solid fa-film"></i>
    <p>No downloaded torrents found in your Real-Debrid library.</p>
    <p>Search for content on the <a href="{{ url_for('search.index') }}">Search</a> page to get started.</p>
</div>
{% endif %}

<!-- Reuse the RD Manager modal for file browsing -->
<div class="rd-modal" id="rdModal">
    <div class="rd-modal-content">
        <span class="rd-close" data-action="close-modal" data-id="rdModal">&times;</span>
        <h3 id="modal-files-title">Files in Torrent</h3>
        <ul id="files-list"></ul>
    </div>
</div>
{% endblock %}